apply plugin: 'maven'

task versionArchives {
    description = "Creates a continuous-delivery friendly version number for the service"
    def buildNumber = System.getenv('BUILD_NUMBER') ?: 0

    // Default to building SNAPSHOT versions unless the build was executed with the -PreleaseType={type} command line parameter
    if (project.hasProperty('releaseType')) {
        if (project.releaseType == 'release') {
            project.ext.set("releaseVersion", "${project.version}." + buildNumber);
        } else if (project.releaseType == 'snapshot') {
            project.ext.set("releaseVersion", "${project.version}-SNAPSHOT");
        } else {
            throw new RuntimeException("Invalid releaseType specified:  Must be 'release' or 'snapshot'!")
        }
    } else {
        logger.info("Property 'releaseType' was not specified.  Defaulting to 'snapshot'!")
        project.ext.set("releaseVersion", "${project.version}-SNAPSHOT");
    }

    logger.info("Setting artifact version: ${releaseVersion}")
    project.version = "${releaseVersion}"
}
build.dependsOn versionArchives
uploadArchives.dependsOn versionArchives

jar {
    baseName = "${artifact}"
    version = "${releaseVersion}"
}

publishing {
    publications {
        maven(MavenPublication) {
            from components.java

            artifact sourcesJar
            artifact javadocJar
        }
    }
}

bintray {
    user = project.hasProperty('bintrayUser') ? project.property('bintrayUser') : System.getenv('BINTRAY_USER')
    key = project.hasProperty('bintrayKey') ? project.property('bintrayKey') : System.getenv('BINTRAY_KEY')
    publications = ['maven']
    pkg {
        repo = 'gregwhitaker'
        name = "${artifact}"
        userOrg = 'ignitr'
        desc = 'Library of common components used by Ignition SpringBoot projects'
        websiteUrl = 'https://github.com/gregwhitaker/reactive-sqs-client'
        issueTrackerUrl = 'https://github.com/gregwhitaker/reactive-sqs-client/issues'
        vcsUrl = 'https://github.com/gregwhitaker/reactive-sqs-client.git'
        licenses = ['Apache-2.0']
        githubRepo = 'gregwhitaker/ignition-springboot-common'
        githubReleaseNotesFile = 'CHANGELOG.md'

        version {
            name = "${releaseVersion}"
        }
    }
}